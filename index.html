<!DOCTYPE html>
<html manifest="./manifest.appcache"><head>
<title>---</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta charset=utf-8></head>
<body></body>
<script>
(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
;(function () {

var BinaryXHR = require('binary-xhr')
var toBase64 = require('arraybuffer-base64')

var Progress = require('hyperprogress')

var prog = Progress()
var running = false

window.WebBoot = {
  scorchedEarth: scorchedEarth,
  reinitialize: reinitialize,
  add: add,
  run: run
}

function parse (str) {
  try {
    return JSON.parse(str)
  } catch (_) { }
}

document.body.appendChild(prog)

//split the hash.

var parts = window.location.hash.split('#').slice(1)
var hasHash = /([A-Za-z0-9\/+]{43}=)\.sha256/
var isUrl = /^https?:\/\//

var APPNAME = 'SWB'
var match = new RegExp('^'+APPNAME)

function log (msg) {
  console.log(APPNAME, msg)
}

function hash(data, cb) {
  window.crypto.subtle.digest(
    {  name: "SHA-256" },
    new Uint8Array(data)
  )
  .then(function(hash){
    return cb(null, toBase64(new Uint8Array(hash)))
  })
  .catch(function(err){
      cb(err)
  })
}

function reinitialize () {
  for(var k in localStorage) {
    if(match.test(k))
      delete localStorage[k]
  }
}

//destroy everything
function scorchedEarth () {
  for(var k in localStorage) {
    delete localStorage[k]
  }
}

function run (id, cb) {
  //if we are already running, restart
  if(running) {
    //leave a note in local storage, and restart.
    location.hash = '#run:'+id
  }
  var text = localStorage[APPNAME+'_version_'+id]
  hash(new TextEncoder('utf8').encode(text), function (err, _id) {
    if(id !== _id) {
      //LOCAL STORAGE CORRUPTED
      cb(new Error('localStorage is corrupted'))
    }
    else {
      var script = document.createElement('script')
      script.textContent = text
      document.head.appendChild(script) //run javascript.
    }
  })

}

function add (secure_url, cb) {
  if(!(isUrl.test(secure_url) && hasHash.test(secure_url)))
    return cb(new Error('is not a secure url:'+secure_url))
  var id = hasHash.exec(parts[0])[1]
  BinaryXHR(secure_url, function (err, buf) {
    if(err)
      return prog.fail(err, 'could not retrive secure url')
    if(!buf)
      return prog.fail(new Error('could not retrive:'+secure_url))

    hash(buf, function (err, _id) {
      if(err)
        return prog.fail(err, 'hash failed')

      if(id !== _id) {
        return prog.fail(new Error('secure url is invalid'))
      }
      cb(null, _id)
    })
  })
}

if(parts.length && isUrl.test(parts[0]) && hasHash.test(parts[0])) {
  var id = hasHash.exec(parts[0])[1]
  prog.next('detected secure url:'+ parts[0])
  window.location.hash = '#'+parts.slice(1).join('#')

  var current = localStorage[APPNAME+'_current']
  if(current && current !== id)
    if(!confirm("this action updates code to:"+id + "\nclick 'cancel' to continue with current version"))
      return run(current)

  //check if we already have this data.
  if(localStorage[APPNAME+'_version_'+id]) {
    prog.next('loading local version')
    run(id)
  } else {
    prog.next('retriving secure url:'+parts[0])
    add(parts[0], function (err, id) {
      if(err) return prog.fail(err)

      prog.next('loading secure javascript')
      //returned data is correct. save, then run.
      localStorage[APPNAME+'_version_'+id] = new TextDecoder('utf8').decode(buf)
      localStorage[APPNAME+'_current'] = id

      var versions = parse(localStorage[APPNAME+'_versions']) || {}
      versions[Date.now()] = id
      localStorage[APPNAME+'_versions'] = JSON.stringify(versions)

      window.location = '#' + parts.slice(1).join('#')
      window.location.reload()

    })
  }
}
else if(localStorage[APPNAME+'_current']) {
  run(localStorage[APPNAME+'_current'])
}
else {
  prog.next('no code to run: paste #{secure_url} to a javascript file.')
}

})();







},{"arraybuffer-base64":2,"binary-xhr":3,"hyperprogress":4}],2:[function(require,module,exports){
module.exports = function ToBase64(buf) {
  buf = new Uint8Array(buf)
  var s = ''
  for(var i = 0; i < buf.byteLength; i++)
    s+=String.fromCharCode(buf[i])
  return btoa(s)
}


},{}],3:[function(require,module,exports){
var inherits = require('inherits')

module.exports = function(url, cb) {
  return new BinaryXHR(url, cb)
}

function BinaryXHR(url, cb) {
  var self = this
  var xhr = new XMLHttpRequest()
  this.xhr = xhr
  xhr.open("GET", url, true)
  xhr.responseType = 'arraybuffer'
  xhr.onreadystatechange = function () {
    if (self.xhr.readyState === 4) {
      if (self.xhr.status !== 200) {
        cb(self.xhr.status, self.xhr.response);
      } else if (self.xhr.response && self.xhr.response.byteLength > 0) {
        cb(false, self.xhr.response)
      } else {
        if (self.xhr.response && self.xhr.response.byteLength === 0) return cb('response length 0')
        cb('no response')
      }
    }
  }
  xhr.send(null)
}

},{"inherits":5}],4:[function(require,module,exports){

function create (tag, classname, children) {
  var el = document.createElement(tag)
  classname && el.classList.add(classname)
  children && children.forEach(function (e) {
    console.log('append', e)
    el.appendChild(
      'string' === typeof e ? document.createTextNode(e) : e
    )
  })
  return el
}

module.exports = function (steps) {
  var list = create('ul', 'hyperprogress__list')
  var error = create('pre', 'hyperprogress__error')
  var liquid = create('div', 'hyperprogress__liquid', ['.'])
  var bar = create('div', 'hyperprogress__bar', [liquid])
  liquid.style.width = '0%'

  var n = 0

  var prog = create('div', 'hyperprogress', [
    steps ? bar : '',
    list,
    //only show bar if a number of steps is provided.
    error
  ])

  prog.complete = function () {
    liquid.style.width = '100%'
    prog.classList.add('hyperprogress--complete')
  }

  prog.next = function (name) {
    n = Math.min(n+1, steps)
    if(list.lastChild)
      list.lastChild.classList.add('hyperprogress--okay')

    if(name)
      list.appendChild(create('li', 'hyperprogress__started', [name]))

    liquid.style.width = Math.round((n/steps)*100)+'%'

    if(n === steps)
      prog.complete()
  }

  prog.fail = function (err) {
    prog.classList.add('hyperprogress--failed')
    list.lastChild.classList.add('hyperprogress--error')
    if(err && err.stack)
      error.textContent = err.stack
  }

  prog.reset = function () {
    n = 0
    error.innerHTML = list.innerHTML = ''
    liquid.style.width = '0%'
    return prog
  }

  return prog
}




},{}],5:[function(require,module,exports){
module.exports = inherits

function inherits (c, p, proto) {
  proto = proto || {}
  var e = {}
  ;[c.prototype, proto].forEach(function (s) {
    Object.getOwnPropertyNames(s).forEach(function (k) {
      e[k] = Object.getOwnPropertyDescriptor(s, k)
    })
  })
  c.prototype = Object.create(p.prototype, e)
  c.super = p
}

//function Child () {
//  Child.super.call(this)
//  console.error([this
//                ,this.constructor
//                ,this.constructor === Child
//                ,this.constructor.super === Parent
//                ,Object.getPrototypeOf(this) === Child.prototype
//                ,Object.getPrototypeOf(Object.getPrototypeOf(this))
//                 === Parent.prototype
//                ,this instanceof Child
//                ,this instanceof Parent])
//}
//function Parent () {}
//inherits(Child, Parent)
//new Child

},{}]},{},[1]);
</script>
</html>
